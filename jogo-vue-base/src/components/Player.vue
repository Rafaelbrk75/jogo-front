<template>
  <img
    :src="currentSprite"
    alt="Jogador"
    class="player"
    :style="{ left: x + '%', bottom: y + '%' }"
  />
</template>

<script setup>
import { ref, computed, onMounted, onBeforeUnmount, watch } from "vue";

const emit = defineEmits(["update:x", "update:y", "update:direcao", "update:estado"]);

const props = defineProps({
  initialX: { type: Number, default: 10 },
  initialY: { type: Number, default: 0 },
  pausado: { type: Boolean, default: false },
});

const x = ref(props.initialX);
const y = ref(props.initialY);
watch(
  () => props.initialX,
  (novoX) => {
    x.value = novoX;
  }
);

watch(
  () => props.initialY,
  (novoY) => {
    y.value = novoY;
  }
);

const speed = 10;
const jumpForce = 9;
const gravity = 0.4;
let velocityY = 0;
const somPulo = new Audio("/somPulo.mp3");
somPulo.volume = 1.0;
const somAgachando = new Audio("/somAgachando.mp3");
somAgachando.volume = 1.0;

const grounded = ref(true);
const agachado = ref(false);
const direcao = ref("direita");
const moving = { left: false, right: false, down: false };
const playerX = ref(10);
const larguraTela = ref(window.innerWidth);
const alturaTela = ref(window.innerHeight);

function pxToPercentX(px) {
  return (px / larguraTela.value) * 100;
}

function percentToPxX(percent) {
  return (percent / 100) * larguraTela.value;
}

function atualizarX(novoX) {
  playerX.value = novoX;
}

// SPRITES ESTÁTICOS POR DIREÇÃO
const sprites = {
  direita: "/player.png",
  esquerda: "/bonecoVoltando.png",
  pulandoDireita: "/playerGiro.png",
  pulandoEsquerda: "/jumpVoltando.png",
  agachadoDireita: "/agachado.png",
  agachadoEsquerda: "/agachado2.png",
};

const currentSprite = computed(() => {
  if (!grounded.value) {
    return direcao.value === "esquerda"
      ? sprites.pulandoEsquerda
      : sprites.pulandoDireita;
  }

  if (agachado.value) {
    return direcao.value === "esquerda"
      ? sprites.agachadoEsquerda
      : sprites.agachadoDireita;
  }

  return sprites[direcao.value];
});

let rafId = null;
function gameLoop() {
  if (props.pausado) return;
  
  emit("update:x", x.value);

  if (moving.left) x.value = Math.max(0, x.value - pxToPercentX(speed));
  if (moving.right) x.value = Math.min(100, x.value + pxToPercentX(speed));

  if (!grounded.value) {
    velocityY -= gravity;
    y.value += velocityY;
    if (y.value <= 0) {
      y.value = 0;
      velocityY = 0;
      grounded.value = true;
    }
  }

  if (grounded.value) {
  y.value = agachado.value ? -8 : 0;
}

  emit("update:x", x.value);
  emit("update:y", y.value);
  emit("update:direcao", direcao.value);
  emit("update:estado", {
    grounded: grounded.value,
    agachado: agachado.value,
  });

  rafId = requestAnimationFrame(gameLoop);
}

function onKeyDown(e) {
  if (props.pausado) return;

  if (e.key === "a") {
    moving.left = true;
    moving.right = false;
    direcao.value = "esquerda";
  }

  if (e.key === "d") {
    moving.right = true;
    moving.left = false;
    direcao.value = "direita";
  }

  if (e.key === "s" && grounded.value) {
    moving.down = true;
    agachado.value = true;
    y.value = 0;

    somAgachando.currentTime = 0;
    somAgachando.play().catch(() => {});
  }

  if ((e.key === " " || e.key === "w") && grounded.value && !agachado.value) {
    grounded.value = false;
    agachado.value = false;
    velocityY = jumpForce;

    somPulo.currentTime = 0;
    somPulo.play().catch(() => {});
  }
}

function onKeyUp(e) {
  if (props.pausado) return;
  if (e.key === "a") moving.left = false;
  if (e.key === "d") moving.right = false;
  if (e.key === "s") {
    moving.down = false;
    agachado.value = false;
    if (grounded.value) y.value = 0;
  }
}

onMounted(() => {
  window.focus(); // garante que o jogo esteja em foco após sair do Menu
  direcao.value = "direita";
  window.addEventListener("keydown", onKeyDown);
  window.addEventListener("keyup", onKeyUp);
  rafId = requestAnimationFrame(gameLoop);
});


onBeforeUnmount(() => {
  window.removeEventListener("keydown", onKeyDown);
  window.removeEventListener("keyup", onKeyUp);
  if (rafId) cancelAnimationFrame(rafId);
});

watch(
  () => props.pausado,
  (novo) => {
    if (novo) {
      if (rafId) {
        cancelAnimationFrame(rafId);
        rafId = null;
      }
    } else {
      if (!rafId) {
        rafId = requestAnimationFrame(gameLoop);
      }
    }
  }
);
</script>

<style scoped>
.player {
  position: absolute;
  width: 13vw;
  height: auto;
  min-width: 130px;
  max-height: 230px;
  transition: left 0.1s, bottom 0.1s;
  z-index: 2;
}
</style>